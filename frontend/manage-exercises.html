<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stretch Coach ‚Äì √úbungen verwalten</title>
    <style>
      :root {
        color-scheme: light;
        --bg-gradient: linear-gradient(135deg, #7f7fd5, #86a8e7, #91eae4);
        --surface: rgba(255, 255, 255, 0.9);
        --surface-strong: rgba(255, 255, 255, 0.95);
        --text-primary: #1a2a3a;
        --text-secondary: #516170;
        --accent: #3d8bff;
        --accent-strong: #2f6ad8;
        --accent-warn: #f39c12;
        --accent-stop: #e74c3c;
        --accent-soft: rgba(61, 139, 255, 0.12);
        --accent-border: rgba(61, 139, 255, 0.25);
        --radius-large: 24px;
        --radius-medium: 16px;
        --shadow: 0 20px 40px rgba(26, 42, 58, 0.18);
        --shadow-soft: 0 12px 24px rgba(26, 42, 58, 0.14);
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
          "Helvetica Neue", Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: clamp(1.5rem, 4vw, 3rem);
        background: var(--bg-gradient);
        color: var(--text-primary);
      }

      main {
        width: min(1080px, 100%);
        margin: 0 auto;
        display: grid;
        gap: clamp(1.5rem, 3vw, 2.5rem);
      }

      .page-nav {
        display: flex;
        justify-content: flex-start;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.65rem 1.1rem;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
        color: #fff;
        text-decoration: none;
        font-weight: 600;
        box-shadow: 0 10px 20px rgba(61, 139, 255, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
      }

      .back-link:hover,
      .back-link:focus-visible {
        filter: brightness(1.05);
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(61, 139, 255, 0.32);
      }

      .card {
        background: var(--surface);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-large);
        box-shadow: var(--shadow);
        padding: clamp(1.4rem, 3vw, 2rem);
        display: grid;
        gap: clamp(1rem, 2vw, 1.4rem);
      }

      .intro-card {
        text-align: center;
        gap: 0.6rem;
      }

      .intro-card h1 {
        margin: 0;
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        letter-spacing: -0.02em;
      }

      .intro-card p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 1rem;
      }

      .toolbar,
      .info-card {
        gap: clamp(1rem, 2vw, 1.4rem);
      }

      .toolbar {
        align-items: start;
      }

      .info-card {
        color: var(--text-secondary);
        font-size: 0.95rem;
      }

      .info-card p {
        margin: 0;
        line-height: 1.5;
      }

      .toolbar-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      button,
      input,
      textarea,
      select {
        font-family: inherit;
      }

      button {
        padding: 0.75rem 1.2rem;
        border-radius: 14px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease;
      }

      button.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
        color: #fff;
        box-shadow: 0 12px 22px rgba(61, 139, 255, 0.28);
      }

      button.secondary {
        background: var(--accent-soft);
        color: var(--accent-strong);
        border: 1px solid var(--accent-border);
        box-shadow: none;
      }

      button.danger {
        background: rgba(231, 76, 60, 0.12);
        color: var(--accent-stop);
        border: 1px solid rgba(231, 76, 60, 0.25);
        box-shadow: none;
      }

      button:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(61, 139, 255, 0.35);
      }

      button:hover {
        transform: translateY(-1px);
        filter: brightness(1.05);
      }

      button:active {
        transform: translateY(0);
        filter: brightness(0.95);
      }

      button:disabled {
        opacity: 0.65;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        filter: none;
      }

      .search-filter {
        display: grid;
        gap: 0.4rem;
      }

      .search-filter label {
        font-weight: 600;
        color: var(--text-secondary);
      }

      .search-filter input {
        width: min(320px, 100%);
        padding: 0.75rem 1rem;
        border-radius: var(--radius-medium);
        border: 1px solid rgba(61, 139, 255, 0.18);
        background: rgba(255, 255, 255, 0.85);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .search-filter input:focus-visible {
        border-color: rgba(61, 139, 255, 0.5);
        box-shadow: 0 0 0 4px rgba(61, 139, 255, 0.2);
        outline: none;
      }

      #exerciseContainer {
        display: grid;
        gap: clamp(1.2rem, 2.4vw, 1.6rem);
      }

      .exercise-list {
        padding: clamp(1.2rem, 2.4vw, 1.6rem);
      }

      .exercise-segment {
        background: var(--surface-strong);
        border-radius: var(--radius-large);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--accent-border);
        padding: clamp(1.2rem, 2.4vw, 1.6rem);
        display: grid;
        gap: 1rem;
      }

      .segment-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .segment-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .segment-actions button {
        white-space: nowrap;
      }

      .segment-header h2 {
        margin: 0;
        font-size: 1.2rem;
      }

      .field-grid {
        display: grid;
        gap: 1rem;
      }

      @media (min-width: 680px) {
        .field-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .field-grid .full-width {
          grid-column: 1 / -1;
        }
      }

      label {
        font-weight: 600;
        display: block;
        margin-bottom: 0.35rem;
        color: var(--text-secondary);
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-medium);
        border: 1px solid rgba(61, 139, 255, 0.18);
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        font-size: 1rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      textarea {
        resize: vertical;
        min-height: 120px;
      }

      select {
        appearance: none;
        background-image:
          linear-gradient(45deg, transparent 50%, var(--accent-strong) 50%),
          linear-gradient(135deg, var(--accent-strong) 50%, transparent 50%);
        background-position:
          calc(100% - 18px) calc(50% + 1px),
          calc(100% - 12px) calc(50% + 1px);
        background-size: 6px 6px;
        background-repeat: no-repeat;
        padding-right: 2.5rem;
        cursor: pointer;
      }

      input:focus-visible,
      textarea:focus-visible,
      select:focus-visible {
        outline: none;
        border-color: rgba(61, 139, 255, 0.55);
        box-shadow: 0 0 0 4px rgba(61, 139, 255, 0.2);
      }

      .validation-message {
        font-size: 0.85rem;
        color: var(--accent-stop);
        margin-top: 0.3rem;
      }

      details.instructions summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--accent-strong);
        margin-bottom: 0.4rem;
      }

      .status-area {
        min-height: 2.2rem;
        padding: 0.9rem 1.2rem;
        border-radius: var(--radius-medium);
        background: rgba(61, 139, 255, 0.1);
        border: 1px solid var(--accent-border);
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .status-area[data-type="error"] {
        background: rgba(231, 76, 60, 0.14);
        color: #a12315;
        border-color: rgba(231, 76, 60, 0.35);
      }

      .status-area[data-type="warn"] {
        background: rgba(243, 156, 18, 0.18);
        color: #8c5a05;
        border-color: rgba(243, 156, 18, 0.35);
      }

      .status-area[data-type="success"] {
        background: rgba(46, 204, 113, 0.18);
        color: #1f6f3a;
        border-color: rgba(46, 204, 113, 0.35);
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <main>
      <nav class="page-nav">
        <a class="back-link" href="./index.html" aria-label="Zur√ºck zur Startseite">‚Üê Zur√ºck</a>
      </nav>

      <header class="card intro-card">
        <h1>üõ†Ô∏è √úbungen verwalten</h1>
        <p>
          Bearbeite bestehende Stretching-Einheiten, erg√§nze neue √úbungen und exportiere
          deine √Ñnderungen als JSON-Datei.
        </p>
      </header>

      <section class="card toolbar" id="exerciseEditor">
        <div class="toolbar-actions">
          <button type="button" class="primary" id="addExerciseBtn">
            Neue √úbung hinzuf√ºgen
          </button>
          <button type="button" class="secondary" id="downloadBtn">
            JSON herunterladen
          </button>
        </div>
        <div class="search-filter">
          <label for="searchInput">Suche (Name oder Anleitung)</label>
          <input
            id="searchInput"
            type="search"
            placeholder="Tippe, um Eintr√§ge zu filtern‚Ä¶"
            autocomplete="off"
          />
        </div>
        <div id="statusArea" class="status-area" role="status"></div>
      </section>

      <section class="card exercise-list" id="exerciseContainer"></section>

      <aside class="card info-card">
        <h2>Hinweis zum Deployment</h2>
        <p>
          Mit <strong>Speichern</strong> werden √Ñnderungen direkt an die Exercises-API
          √ºbertragen. Der JSON-Export dient als Sicherung oder zur Migration in
          andere Umgebungen (z.‚ÄØB. mittels <code>scripts/import_exercises.py</code>).
        </p>
        <p>
          Nutze die Suchfunktion, um schnell bestimmte √úbungen zu finden, und
          klappe lange Anleitungen bei Bedarf √ºber die Abschnittsk√∂pfe ein.
        </p>
        <p>
          Lege zudem fest, ob eine √úbung im <strong>Achtsamkeitsmodus</strong> stattfindet
          oder ob die <strong>Pausenglocke</strong> erklingen soll.
        </p>
      </aside>
    </main>

    <template id="exerciseTemplate">
      <article class="exercise-segment" data-visible="true">
        <div class="segment-header">
          <h2>√úbung</h2>
          <div class="segment-actions">
            <button type="button" class="secondary duplicate-btn">Duplizieren</button>
            <button type="button" class="primary save-btn">Speichern</button>
            <button type="button" class="danger delete-btn">L√∂schen</button>
          </div>
        </div>
        <div class="field-grid">
          <div class="field">
            <label>Id *</label>
            <input name="id" required />
            <div class="validation-message hidden"></div>
          </div>
          <div class="field">
            <label>Name *</label>
            <input name="name" required />
            <div class="validation-message hidden"></div>
          </div>
          <div class="field full-width">
            <label>Anleitung *</label>
            <details class="instructions" open>
              <summary>Anleitung anzeigen/ausblenden</summary>
              <textarea name="instruction" required></textarea>
            </details>
            <div class="validation-message hidden"></div>
          </div>
          <div class="field">
            <label>Vorbereitungszeit (Sek.)</label>
            <input name="prep_time" type="number" min="0" step="1" />
            <div class="validation-message hidden"></div>
          </div>
          <div class="field">
            <label>Dauer (Sek.)</label>
            <input name="duration" type="number" min="0" step="1" />
            <div class="validation-message hidden"></div>
          </div>
          <div class="field">
            <label>Wiederholungsdauer (Sek.)</label>
            <input name="rep_time" type="number" min="0" step="1" />
            <div class="validation-message hidden"></div>
          </div>
          <div class="field">
            <label>S√§tze</label>
            <input name="sets" type="number" min="0" step="1" />
            <div class="validation-message hidden"></div>
          </div>
          <div class="field">
            <label>Pause (Sek.)</label>
            <input name="rest_time" type="number" min="0" step="1" />
            <div class="validation-message hidden"></div>
          </div>
          <div class="field">
            <label>Achtsamkeitsmodus</label>
            <select name="mindfulness">
              <option value="">Nicht festgelegt</option>
              <option value="yes">Ja</option>
              <option value="no">Nein</option>
            </select>
            <div class="validation-message hidden"></div>
          </div>
          <div class="field">
            <label>Pausenglocke</label>
            <select name="break_bell">
              <option value="">Nicht festgelegt</option>
              <option value="yes">Aktiviert</option>
              <option value="no">Deaktiviert</option>
            </select>
            <div class="validation-message hidden"></div>
          </div>
        </div>
      </article>
    </template>

    <script src="./config.production.js"></script>
    <script>
      const config = window.STRETCH_COACH_CONFIG || {};
      const rawExercisesApiUrl = (config.exercisesApiUrl || "").trim();
      const exercisesApiUrl = rawExercisesApiUrl.replace(/\/$/, "");
      const hasApi = Boolean(exercisesApiUrl);

      const exerciseContainer = document.getElementById("exerciseContainer");
      const template = document.getElementById("exerciseTemplate");
      const addBtn = document.getElementById("addExerciseBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const searchInput = document.getElementById("searchInput");
      const statusArea = document.getElementById("statusArea");

      const numberFields = [
        "prep_time",
        "duration",
        "rep_time",
        "sets",
        "rest_time",
      ];

      const defaultExercise = () => ({
        id: "",
        name: "",
        instruction: "",
        prep_time: "",
        duration: "",
        rep_time: "",
        sets: "",
        rest_time: "",
        mindfulness: "",
        break_bell: "",
      });

      const joinApiUrl = (suffix = "") => {
        if (!suffix) {
          return exercisesApiUrl;
        }
        return `${exercisesApiUrl}/${suffix.replace(/^\//, "")}`;
      };

      const setStatus = (message, type = "info") => {
        statusArea.textContent = message;
        statusArea.dataset.type = type;
      };

      const apiRequest = async (method, path = "", payload) => {
        if (!hasApi) {
          throw new Error("Es wurde kein Exercises-API-Endpunkt konfiguriert.");
        }
        const url = path ? joinApiUrl(path) : exercisesApiUrl;
        const options = {
          method,
          cache: "no-store",
          headers: {
            Accept: "application/json",
          },
        };
        if (payload !== undefined) {
          options.headers["Content-Type"] = "application/json";
          options.body = JSON.stringify(payload);
        }
        const response = await fetch(url, options);
        if (!response.ok) {
          let message = `Fehler ${response.status}`;
          try {
            const errorBody = await response.json();
            if (errorBody && typeof errorBody.error === "string") {
              message = errorBody.error;
            }
          } catch (parseError) {
            // ignorieren, Fallback oben verwenden
          }
          throw new Error(message);
        }
        if (response.status === 204) {
          return null;
        }
        return response.json();
      };

      const validateField = (input) => {
        const value = input.value.trim();
        const field = input.closest(".field");
        const messageEl = field?.querySelector(".validation-message");

        let error = "";

        if (input.hasAttribute("required") && !value) {
          error = "Pflichtfeld ausf√ºllen.";
        } else if (input.type === "number" && value !== "") {
          const numberValue = Number(value);
          if (Number.isNaN(numberValue)) {
            error = "Bitte eine g√ºltige Zahl eingeben.";
          } else if (numberValue < 0) {
            error = "Der Wert darf nicht negativ sein.";
          } else if (input.name === "sets" && numberValue < 1) {
            error = "Bitte mindestens 1 angeben.";
          }
        }

        if (messageEl) {
          if (error) {
            messageEl.textContent = error;
            messageEl.classList.remove("hidden");
            input.setAttribute("aria-invalid", "true");
          } else {
            messageEl.textContent = "";
            messageEl.classList.add("hidden");
            input.removeAttribute("aria-invalid");
          }
        }

        return !error;
      };

      const bindFieldValidation = (segment) => {
        const inputs = segment.querySelectorAll("input, textarea, select");
        inputs.forEach((input) => {
          input.addEventListener("blur", () => validateField(input));
          const updateEvents = input.tagName === "SELECT" ? ["change"] : ["input", "change"];
          updateEvents.forEach((eventName) => {
            input.addEventListener(eventName, () => {
              if (input.getAttribute("aria-invalid") === "true") {
                validateField(input);
              }
              if (input.name === "name") {
                const heading = segment.querySelector(".segment-header h2");
                heading.textContent = input.value
                  ? `√úbung: ${input.value}`
                  : "√úbung";
              }
              segment.dataset.dirty = "true";
            });
          });
        });
      };

      const fillSegment = (segment, data) => {
        const inputs = segment.querySelectorAll("input, textarea, select");
        inputs.forEach((input) => {
          const value = data[input.name];
          input.value = value !== undefined && value !== null ? value : "";
        });

        const nameInput = segment.querySelector('input[name="name"]');
        if (nameInput) {
          const heading = segment.querySelector(".segment-header h2");
          heading.textContent = nameInput.value
            ? `√úbung: ${nameInput.value}`
            : "√úbung";
        }
      };

      const toggleSegmentBusy = (segment, busy) => {
        const controls = segment.querySelectorAll("button, input, textarea, select");
        controls.forEach((control) => {
          control.disabled = busy;
        });
      };

      const collectSegmentExercise = (segment) => {
        const inputs = segment.querySelectorAll("input, textarea, select");
        const entry = {};
        let isValid = true;

        inputs.forEach((input) => {
          const ok = validateField(input);
          if (!ok) {
            isValid = false;
          }
          let value = input.value.trim();
          if (numberFields.includes(input.name)) {
            value = value === "" ? "" : Number(value);
          }
          entry[input.name] = value;
        });

        if (!isValid) {
          const label = entry.name || entry.id || "ohne Namen";
          throw new Error(`Bitte Eingaben in der √úbung ‚Äû${label}" korrigieren.`);
        }

        const normalized = { ...entry };
        numberFields.forEach((field) => {
          if (normalized[field] === "" || normalized[field] === undefined) {
            delete normalized[field];
          } else {
            normalized[field] = Number(normalized[field]);
          }
        });
        ["mindfulness", "break_bell"].forEach((field) => {
          if (!normalized[field]) {
            delete normalized[field];
          }
        });
        return normalized;
      };

      const readSegmentValues = (segment) => {
        const inputs = segment.querySelectorAll("input, textarea, select");
        const entry = defaultExercise();
        inputs.forEach((input) => {
          entry[input.name] = input.value;
        });
        return entry;
      };

      const setSegmentPersisted = (segment, item) => {
        segment.dataset.persisted = "true";
        segment.dataset.originalId = item.id || "";
        segment.dataset.dirty = "false";
        fillSegment(segment, defaultExercise());
        fillSegment(segment, item);
      };

      const attachSegmentActions = (segment) => {
        const deleteBtn = segment.querySelector(".delete-btn");
        const saveBtn = segment.querySelector(".save-btn");
        const duplicateBtn = segment.querySelector(".duplicate-btn");

        saveBtn.addEventListener("click", async () => {
          try {
            const payload = collectSegmentExercise(segment);
            toggleSegmentBusy(segment, true);
            if (segment.dataset.persisted === "true") {
              const previousId = segment.dataset.originalId || payload.id;
              const body = { ...payload };
              if (previousId && previousId !== payload.id) {
                body.previousId = previousId;
              }
              const response = await apiRequest("PUT", previousId, body);
              const saved = response?.item || payload;
              setSegmentPersisted(segment, saved);
              setStatus(`√úbung ‚Äû${saved.name || saved.id}" aktualisiert.`, "success");
            } else {
              const response = await apiRequest("POST", "", payload);
              const saved = response?.item || payload;
              setSegmentPersisted(segment, saved);
              setStatus(`√úbung ‚Äû${saved.name || saved.id}" gespeichert.`, "success");
            }
          } catch (error) {
            console.error(error);
            setStatus(error.message || "Speichern fehlgeschlagen.", "error");
          } finally {
            toggleSegmentBusy(segment, false);
            filterSegments(searchInput.value);
          }
        });

        deleteBtn.addEventListener("click", async () => {
          const name = segment.querySelector('input[name="name"]').value || segment.querySelector('input[name="id"]').value;
          if (segment.dataset.persisted === "true") {
            const originalId = segment.dataset.originalId;
            const confirmed = window.confirm(
              `M√∂chtest du die √úbung ‚Äû${name || originalId}" wirklich l√∂schen?`
            );
            if (!confirmed) {
              return;
            }
            try {
              toggleSegmentBusy(segment, true);
              await apiRequest("DELETE", originalId);
              segment.remove();
              setStatus(`√úbung ‚Äû${name || originalId}" wurde gel√∂scht.`, "success");
            } catch (error) {
              console.error(error);
              setStatus(error.message || "L√∂schen fehlgeschlagen.", "error");
            } finally {
              toggleSegmentBusy(segment, false);
              filterSegments(searchInput.value);
            }
          } else {
            segment.remove();
            setStatus("Nicht gespeicherte √úbung verworfen.", "info");
            filterSegments(searchInput.value);
          }
        });

        duplicateBtn.addEventListener("click", () => {
          const values = readSegmentValues(segment);
          const copy = { ...values };
          copy.id = values.id ? `${values.id}-copy` : "";
          const newSegment = addExerciseSegment(copy, false);
          setStatus("√úbung dupliziert. Bitte neue ID vergeben und speichern.", "info");
          newSegment.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      };

      const addExerciseSegment = (data = defaultExercise(), persisted = false) => {
        const fragment = template.content.cloneNode(true);
        const segment = fragment.querySelector(".exercise-segment");
        segment.dataset.persisted = persisted ? "true" : "false";
        segment.dataset.originalId = persisted && data.id ? data.id : "";
        segment.dataset.dirty = persisted ? "false" : "true";
        bindFieldValidation(segment);
        attachSegmentActions(segment);
        fillSegment(segment, data);
        exerciseContainer.appendChild(fragment);
        filterSegments(searchInput.value);
        return segment;
      };

      const filterSegments = (searchTerm) => {
        const lower = searchTerm.trim().toLowerCase();
        const segments = exerciseContainer.querySelectorAll(
          ".exercise-segment"
        );
        segments.forEach((segment) => {
          const name = segment
            .querySelector('input[name="name"]')
            .value.toLowerCase();
          const instruction = segment
            .querySelector('textarea[name="instruction"]')
            .value.toLowerCase();
          const matches =
            !lower || name.includes(lower) || instruction.includes(lower);
          segment.dataset.visible = matches ? "true" : "false";
          segment.style.display = matches ? "grid" : "none";
        });
      };

      const gatherExercises = () => {
        const segments = Array.from(
          exerciseContainer.querySelectorAll(".exercise-segment")
        );
        if (!segments.length) {
          throw new Error("Keine √úbungen vorhanden. Bitte erst welche hinzuf√ºgen.");
        }

        const results = [];
        segments.forEach((segment) => {
          const data = collectSegmentExercise(segment);
          results.push(data);
        });
        return results;
      };

      const downloadJson = (entries) => {
        const blob = new Blob([JSON.stringify(entries, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement("a"), {
          href: url,
          download: "exercises.json",
        });
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
      };

      const loadExercises = async () => {
        exerciseContainer.innerHTML = "";
        if (!hasApi) {
          addExerciseSegment();
          setStatus(
            "Es ist kein Exercises-API-Endpunkt konfiguriert. Arbeiten im Offline-Modus.",
            "warn"
          );
          filterSegments(searchInput.value);
          return;
        }

        try {
          setStatus("Lade vorhandene Daten‚Ä¶");
          const response = await apiRequest("GET");
          const list = Array.isArray(response?.items) ? response.items : [];
          const sanitized = list
            .filter(
              (entry) =>
                entry &&
                typeof entry.id === "string"
            )
            .sort((a, b) => (a.name || "").localeCompare(b.name || "", "de"));
          if (!sanitized.length) {
            addExerciseSegment();
            setStatus(
              "Es wurden keine √úbungen gefunden. Du kannst neue hinzuf√ºgen.",
              "warn"
            );
          } else {
            sanitized.forEach((entry) => addExerciseSegment(entry, true));
            setStatus(`Es wurden ${sanitized.length} √úbungen geladen.`, "success");
          }
        } catch (error) {
          console.error(error);
          addExerciseSegment();
          setStatus(
            "√úbungen konnten nicht geladen werden. Du kannst trotzdem neue hinzuf√ºgen.",
            "error"
          );
        } finally {
          filterSegments(searchInput.value);
        }
      };

      addBtn.addEventListener("click", () => {
        const segment = addExerciseSegment();
        setStatus("Neue √úbung hinzugef√ºgt.", "success");
        segment.scrollIntoView({ behavior: "smooth", block: "start" });
      });

      downloadBtn.addEventListener("click", () => {
        try {
          const exercises = gatherExercises();
          downloadJson(exercises);
          setStatus(
            `${exercises.length} √úbungen wurden exportiert und heruntergeladen.`,
            "success"
          );
        } catch (error) {
          setStatus(error.message, "error");
        }
      });

      searchInput.addEventListener("input", (event) => {
        filterSegments(event.target.value);
      });

      loadExercises();
    </script>
  </body>
</html>
